services:
  firestore:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: gcloud emulators firestore start --host-port=0.0.0.0:8080
    ports:
      - "8080:8080"

  pubsub:
    image: gcr.io/google.com/cloudsdktool/google-cloud-cli:emulators
    command: gcloud beta emulators pubsub start --host-port=0.0.0.0:8085
    ports:
      - "8085:8085"

  firebase-auth:
    image: node:20-alpine
    working_dir: /app
    command: >
      sh -c "npm install -g firebase-tools &&
             firebase emulators:start --only auth --project local-dev"
    ports:
      - "9099:9099"   # Auth emulator
      - "4000:4000"   # Emulator UI
    volumes:
      - ./firebase.json:/app/firebase.json:ro

  telemetry-api:
    profiles: ["test"]
    build: ./services/telemetry-api
    ports:
      - "8000:8080"
    environment:
      - GCP_PROJECT=local-dev
      - FIRESTORE_EMULATOR_HOST=firestore:8080
      - PUBSUB_EMULATOR_HOST=pubsub:8085
      - FIREBASE_AUTH_EMULATOR_HOST=firebase-auth:9099
    depends_on:
      - firestore
      - pubsub
      - firebase-auth